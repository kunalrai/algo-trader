{% extends "base.html" %}

{% block title %}Positions - Trading Bot Dashboard{% endblock %}
{% block page_title %}Active Positions{% endblock %}

{% block content %}
<!-- Position Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <p class="text-sm text-gray-400 uppercase">Total Positions</p>
        <p class="text-3xl font-bold text-white mt-1">
            <span id="total-positions">0</span>/<span id="max-positions">0</span>
        </p>
    </div>
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <p class="text-sm text-gray-400 uppercase">Long Positions</p>
        <p class="text-3xl font-bold text-green-400 mt-1" id="long-positions">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <p class="text-sm text-gray-400 uppercase">Short Positions</p>
        <p class="text-3xl font-bold text-red-400 mt-1" id="short-positions">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <p class="text-sm text-gray-400 uppercase">Unrealized P&L</p>
        <p class="text-3xl font-bold mt-1" id="unrealized-pnl">$0.00</p>
    </div>
</div>

<!-- Active Positions Table -->
<div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 mb-8">
    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Active Positions</h2>
        <button onclick="refreshPositions()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition">
            Refresh
        </button>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Pair</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Side</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Entry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Current</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">P&L</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Leverage</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                </tr>
            </thead>
            <tbody id="positions-table" class="bg-gray-800 divide-y divide-gray-700">
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                        No active positions
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Trading Controls -->
<div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
    <h2 class="text-xl font-bold text-white mb-4">Trading Controls</h2>
    <div class="flex flex-wrap gap-4">
        <button onclick="toggleTradingMode()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
            Toggle Trading Mode
        </button>
        <button onclick="closeAllPositions()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
            Close All Positions
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function refreshPositions() {
    await fetchPositions();
    await fetchStatus();
}

async function fetchPositions() {
    try {
        const response = await fetch('/api/positions');
        const positions = await response.json();
        const tbody = document.getElementById('positions-table');

        let unrealizedPnl = 0;

        if (positions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                        No active positions
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = positions.map(pos => {
                const pnlClass = pos.pnl >= 0 ? 'profit' : 'loss';
                const sideClass = pos.side === 'long' ? 'text-green-400' : 'text-red-400';
                unrealizedPnl += pos.pnl;

                return `
                    <tr class="hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${pos.pair}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="${sideClass} font-semibold uppercase">${pos.side}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${pos.size.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">$${pos.entry_price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">$${pos.current_price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="${pnlClass} font-semibold">
                                $${pos.pnl.toFixed(2)} (${pos.pnl_percent.toFixed(2)}%)
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${pos.leverage}x</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="closePosition('${pos.id}')"
                                    class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded transition duration-200">
                                Close
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update unrealized P&L
        const pnlElement = document.getElementById('unrealized-pnl');
        pnlElement.textContent = `$${unrealizedPnl.toFixed(2)}`;
        pnlElement.className = `text-3xl font-bold mt-1 ${unrealizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

    } catch (error) {
        console.error('Error fetching positions:', error);
    }
}

// Fetch status
async function fetchStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        document.getElementById('total-positions').textContent = data.positions.total;
        document.getElementById('max-positions').textContent = data.config.max_positions;
        document.getElementById('long-positions').textContent = data.positions.long;
        document.getElementById('short-positions').textContent = data.positions.short;
    } catch (error) {
        console.error('Error fetching status:', error);
    }
}

// Close position
async function closePosition(positionId) {
    if (!confirm('Are you sure you want to close this position?')) {
        return;
    }

    try {
        const response = await fetch('/api/close-position', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ position_id: positionId })
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            refreshPositions();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error closing position:', error);
        alert('Failed to close position');
    }
}

// Toggle trading mode
async function toggleTradingMode() {
    if (!confirm('Are you sure you want to toggle the trading mode?')) {
        return;
    }

    try {
        const statusResponse = await fetch('/api/status');
        const statusData = await statusResponse.json();
        const isDryRun = statusData.trading_mode === 'DRY RUN';

        const response = await fetch('/api/trading/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: isDryRun ? 'live' : 'dry_run' })
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            refreshPositions();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error toggling mode:', error);
        alert('Failed to toggle trading mode');
    }
}

// Close all positions
async function closeAllPositions() {
    if (!confirm('Are you sure you want to close ALL positions? This cannot be undone!')) {
        return;
    }

    try {
        const response = await fetch('/api/positions');
        const positions = await response.json();

        for (const pos of positions) {
            await closePosition(pos.id);
        }
    } catch (error) {
        console.error('Error closing all positions:', error);
        alert('Failed to close all positions');
    }
}

// Initial load and refresh
refreshPositions();
setInterval(refreshPositions, 5000);
</script>
{% endblock %}
