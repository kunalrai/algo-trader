{% extends "base.html" %}

{% block title %}Overview - Trading Bot Dashboard{% endblock %}
{% block page_title %}Overview{% endblock %}

{% block content %}
<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Balance Card -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400 uppercase">Total Balance</p>
                <p class="text-2xl font-bold text-white mt-1">
                    $<span id="total-balance">0.00</span>
                </p>
            </div>
            <div class="bg-blue-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </div>
        </div>
        <div class="mt-3 text-xs text-gray-400">
            Available: $<span id="available-balance">0.00</span>
        </div>
        <div id="balance-pnl-display"></div>
    </div>

    <!-- Active Positions Card -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400 uppercase">Active Positions</p>
                <p class="text-2xl font-bold text-white mt-1">
                    <span id="total-positions">0</span>/<span id="max-positions">0</span>
                </p>
            </div>
            <div class="bg-green-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
            </div>
        </div>
        <div class="mt-3 text-xs text-gray-400">
            Long: <span id="long-positions" class="text-green-400">0</span> |
            Short: <span id="short-positions" class="text-red-400">0</span>
        </div>
    </div>

    <!-- Leverage Card -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400 uppercase">Leverage</p>
                <p class="text-2xl font-bold text-white mt-1">
                    <span id="leverage">5</span>x
                </p>
            </div>
            <div class="bg-yellow-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </div>
        </div>
        <div class="mt-3 text-xs text-gray-400">
            SL: <span id="stop-loss">2%</span> | TP: <span id="take-profit">4%</span>
        </div>
    </div>

    <!-- Status Card -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400 uppercase">System Status</p>
                <p class="text-2xl font-bold text-green-400 mt-1">
                    <span id="system-status">Online</span>
                </p>
            </div>
            <div class="bg-green-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-6 h-6 text-green-500 pulse-green" fill="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="8"></circle>
                </svg>
            </div>
        </div>
        <div class="mt-3 text-xs text-gray-400">
            Last update: <span id="last-update">--:--:--</span>
        </div>
    </div>
</div>

<!-- Bot Activity & Runtime Status -->
<div class="bg-gradient-to-r from-indigo-900 to-purple-900 rounded-lg shadow-lg p-6 border border-indigo-600 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            Bot Activity Monitor
        </h2>
        <div class="flex gap-2 items-center">
            <div id="bot-running-indicator" class="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full">
                <div class="w-2 h-2 rounded-full bg-gray-500" id="bot-status-dot"></div>
                <span class="text-xs font-semibold text-gray-400" id="bot-running-text">Stopped</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- Uptime -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <p class="text-xs text-gray-400 uppercase mb-1">Bot Uptime</p>
            <p class="text-xl font-bold text-white" id="bot-uptime">0s</p>
            <p class="text-xs text-gray-500 mt-1">Total Cycles: <span id="total-cycles">0</span></p>
        </div>

        <!-- Last Scan -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <p class="text-xs text-gray-400 uppercase mb-1">Last Scan</p>
            <p class="text-xl font-bold text-white" id="last-scan-time">Never</p>
            <p class="text-xs text-gray-500 mt-1"><span id="seconds-since-scan">--</span>s ago</p>
        </div>

        <!-- Next Scan -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <p class="text-xs text-gray-400 uppercase mb-1">Next Scan In</p>
            <p class="text-xl font-bold text-yellow-400" id="next-scan-countdown">--</p>
            <p class="text-xs text-gray-500 mt-1">Interval: <span id="scan-interval">60</span>s</p>
        </div>

        <!-- Pairs Monitored -->
        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <p class="text-xs text-gray-400 uppercase mb-1">Pairs Monitored</p>
            <p class="text-xl font-bold text-white" id="pairs-count">0</p>
            <p class="text-xs text-gray-500 mt-1" id="pairs-list">--</p>
        </div>
    </div>

    <!-- Current Action / Decision -->
    <div class="bg-gray-800 bg-opacity-70 rounded-lg p-4 border border-indigo-500">
        <div class="flex items-start gap-3">
            <div class="bg-indigo-500 bg-opacity-20 rounded-full p-2 mt-1">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <p class="text-sm text-gray-400 mb-1">Current Action:</p>
                <p class="text-lg font-semibold text-white" id="current-action">Initializing...</p>
                <p class="text-sm text-gray-300 mt-1" id="action-details">Bot starting up...</p>
                <p class="text-xs text-gray-500 mt-2">Last decision: <span id="last-decision-time">N/A</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Strategies Quick Link -->
    <a href="/strategies" class="bg-gradient-to-r from-purple-900 to-pink-900 rounded-lg shadow-lg p-6 border border-purple-600 hover:border-purple-500 transition-all">
        <div class="flex items-center gap-4 mb-4">
            <div class="bg-purple-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-white">Strategies</h3>
                <p class="text-sm text-gray-300 mt-1">Manage trading strategies</p>
            </div>
        </div>
        <div class="text-xs text-gray-400">
            Active: <span id="quick-active-strategy" class="text-white font-semibold">Loading...</span>
        </div>
    </a>

    <!-- Market Analysis Quick Link -->
    <a href="/market" class="bg-gradient-to-r from-blue-900 to-cyan-900 rounded-lg shadow-lg p-6 border border-blue-600 hover:border-blue-500 transition-all">
        <div class="flex items-center gap-4 mb-4">
            <div class="bg-blue-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-white">Market Analysis</h3>
                <p class="text-sm text-gray-300 mt-1">View signals and charts</p>
            </div>
        </div>
        <div class="text-xs text-gray-400">
            Real-time market data
        </div>
    </a>

    <!-- Performance Quick Link -->
    <a href="/performance" class="bg-gradient-to-r from-green-900 to-emerald-900 rounded-lg shadow-lg p-6 border border-green-600 hover:border-green-500 transition-all">
        <div class="flex items-center gap-4 mb-4">
            <div class="bg-green-500 bg-opacity-20 rounded-full p-3">
                <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-white">Performance</h3>
                <p class="text-sm text-gray-300 mt-1">Track P&L and statistics</p>
            </div>
        </div>
        <div class="text-xs text-gray-400">
            Total P&L: <span id="quick-total-pnl" class="text-white font-semibold">$0.00</span>
        </div>
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Fetch status data
async function fetchStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        document.getElementById('total-balance').textContent = data.wallet.total_balance.toFixed(2);
        document.getElementById('available-balance').textContent = data.wallet.available_balance.toFixed(2);

        // Show P&L in balance card if in dry-run mode
        if (data.wallet.total_pnl !== undefined) {
            const pnl = data.wallet.total_pnl;
            const pnlPercent = data.wallet.pnl_percent;
            const pnlText = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)`;
            const pnlClass = pnl >= 0 ? 'text-xs text-green-400 mt-1' : 'text-xs text-red-400 mt-1';

            let pnlDisplay = document.getElementById('balance-pnl-display');
            if (pnlDisplay) {
                pnlDisplay.className = pnlClass;
                pnlDisplay.textContent = `P&L: ${pnlText}`;
            }
        }

        document.getElementById('total-positions').textContent = data.positions.total;
        document.getElementById('max-positions').textContent = data.config.max_positions;
        document.getElementById('long-positions').textContent = data.positions.long;
        document.getElementById('short-positions').textContent = data.positions.short;

        document.getElementById('leverage').textContent = data.config.leverage;
        document.getElementById('stop-loss').textContent = data.config.stop_loss;
        document.getElementById('take-profit').textContent = data.config.take_profit;

        document.getElementById('last-update').textContent = new Date(data.timestamp).toLocaleTimeString();
    } catch (error) {
        console.error('Error fetching status:', error);
    }
}

// Fetch bot runtime status
async function fetchBotStatus() {
    try {
        const response = await fetch('/api/bot/status');
        const status = await response.json();

        const isRunning = status.bot_running;
        const statusDot = document.getElementById('bot-status-dot');
        const statusText = document.getElementById('bot-running-text');

        if (statusDot && statusText) {
            if (isRunning) {
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                statusText.textContent = 'Running';
                statusText.className = 'text-xs font-semibold text-green-400';
            } else {
                statusDot.className = 'w-2 h-2 rounded-full bg-gray-500';
                statusText.textContent = 'Stopped';
                statusText.className = 'text-xs font-semibold text-gray-400';
            }
        }

        const botUptime = document.getElementById('bot-uptime');
        if (botUptime) botUptime.textContent = status.uptime_formatted || '0s';

        const totalCycles = document.getElementById('total-cycles');
        if (totalCycles) totalCycles.textContent = status.total_cycles || 0;

        const lastScanTime = document.getElementById('last-scan-time');
        if (lastScanTime) lastScanTime.textContent = status.last_cycle_formatted || 'Never';

        const secondsSinceScan = document.getElementById('seconds-since-scan');
        if (secondsSinceScan) secondsSinceScan.textContent = status.seconds_since_last_cycle || '--';

        const nextScanCountdown = document.getElementById('next-scan-countdown');
        if (nextScanCountdown) nextScanCountdown.textContent = status.next_scan_countdown || '--';

        const scanInterval = document.getElementById('scan-interval');
        if (scanInterval) scanInterval.textContent = status.scan_interval || 60;

        const pairs = status.pairs_monitored || [];
        const pairsCount = document.getElementById('pairs-count');
        if (pairsCount) pairsCount.textContent = pairs.length;

        const pairsList = document.getElementById('pairs-list');
        if (pairsList) pairsList.textContent = pairs.join(', ') || '--';

        const currentAction = document.getElementById('current-action');
        if (currentAction) currentAction.textContent = status.current_action || 'Stopped';

        const actionDetails = document.getElementById('action-details');
        if (actionDetails) actionDetails.textContent = status.action_details || 'Bot not running';

        const lastDecisionTime = document.getElementById('last-decision-time');
        if (lastDecisionTime) lastDecisionTime.textContent = status.last_decision_formatted || 'N/A';

    } catch (error) {
        console.error('Error fetching bot status:', error);
    }
}

// Fetch quick link data
async function fetchQuickLinkData() {
    try {
        const strategyResponse = await fetch('/api/strategies/active');
        const strategyData = await strategyResponse.json();
        if (strategyData.success && strategyData.active_strategy) {
            document.getElementById('quick-active-strategy').textContent = strategyData.active_strategy.name;
        }

        const pnlResponse = await fetch('/api/simulated/stats');
        if (pnlResponse.ok) {
            const pnlData = await pnlResponse.json();
            const pnl = pnlData.total_pnl || 0;
            const pnlElement = document.getElementById('quick-total-pnl');
            pnlElement.textContent = `$${pnl.toFixed(2)}`;
            pnlElement.className = pnl >= 0 ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold';
        }
    } catch (error) {
        console.error('Error fetching quick link data:', error);
    }
}

// Initial load
fetchStatus();
fetchBotStatus();
fetchQuickLinkData();

// Auto-refresh
setInterval(fetchStatus, 5000);
setInterval(fetchBotStatus, 5000);
setInterval(fetchQuickLinkData, 5000);
</script>
{% endblock %}
