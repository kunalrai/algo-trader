{% extends "base.html" %}

{% block title %}Performance - Trading Bot Dashboard{% endblock %}
{% block page_title %}Performance & Statistics{% endblock %}

{% block content %}
<!-- P&L Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total P&L -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-1">Total P&L</p>
        <p class="text-3xl font-bold" id="pnl-total">$0.00</p>
        <p class="text-sm mt-1" id="pnl-percent">0.00%</p>
    </div>

    <!-- Total Trades -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-1">Total Trades</p>
        <p class="text-3xl font-bold text-white" id="stat-total-trades">0</p>
        <p class="text-sm mt-1 text-gray-400">
            <span class="text-green-400" id="stat-winning">0</span> W /
            <span class="text-red-400" id="stat-losing">0</span> L
        </p>
    </div>

    <!-- Win Rate -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-1">Win Rate</p>
        <p class="text-3xl font-bold text-blue-400" id="stat-win-rate">0%</p>
        <p class="text-sm mt-1 text-gray-400">Success ratio</p>
    </div>

    <!-- Avg P&L -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-1">Avg Win / Loss</p>
        <p class="text-lg font-bold">
            <span class="text-green-400" id="stat-avg-win">$0.00</span>
        </p>
        <p class="text-lg font-bold">
            <span class="text-red-400" id="stat-avg-loss">$0.00</span>
        </p>
    </div>
</div>

<!-- Detailed Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Risk/Reward -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-2">Risk/Reward Ratio</p>
        <p class="text-2xl font-bold text-purple-400" id="stat-rr-ratio">0.00:1</p>
    </div>

    <!-- Largest Win -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-2">Largest Win</p>
        <p class="text-2xl font-bold text-green-400" id="stat-largest-win">$0.00</p>
    </div>

    <!-- Largest Loss -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
        <p class="text-xs text-gray-400 uppercase mb-2">Largest Loss</p>
        <p class="text-2xl font-bold text-red-400" id="stat-largest-loss">$0.00</p>
    </div>
</div>

<!-- Wallet Summary -->
<div class="bg-gradient-to-r from-gray-800 to-gray-700 rounded-lg shadow-lg p-6 border border-gray-600 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Wallet Summary</h2>
        <button onclick="resetWallet()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition duration-200 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Reset Wallet
        </button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-900 rounded-lg p-4">
            <p class="text-xs text-gray-400 uppercase">Initial Balance</p>
            <p class="text-xl font-bold text-white" id="initial-balance">$1,000.00</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4">
            <p class="text-xs text-gray-400 uppercase">Current Balance</p>
            <p class="text-xl font-bold text-white" id="current-balance">$0.00</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4">
            <p class="text-xs text-gray-400 uppercase">Available</p>
            <p class="text-xl font-bold text-white" id="available-balance">$0.00</p>
        </div>
        <div class="bg-gray-900 rounded-lg p-4">
            <p class="text-xs text-gray-400 uppercase">Used Margin</p>
            <p class="text-xl font-bold text-yellow-400" id="used-margin">$0.00</p>
        </div>
    </div>
</div>

<!-- Recent Trades -->
<div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
    <div class="p-6 border-b border-gray-700">
        <h2 class="text-xl font-bold text-white">Recent Trades</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Pair</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Side</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Entry</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Exit</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">P&L</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Reason</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Time</th>
                </tr>
            </thead>
            <tbody id="recent-trades-table" class="divide-y divide-gray-700">
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                        No trades yet. Start trading to see results here!
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function fetchPnLStats() {
    try {
        const response = await fetch('/api/simulated/stats');

        if (response.status === 400) {
            return;
        }

        const stats = await response.json();

        // Update P&L total
        const pnlElement = document.getElementById('pnl-total');
        const pnl = stats.total_pnl || 0;
        pnlElement.textContent = `$${pnl.toFixed(2)}`;
        pnlElement.className = pnl >= 0 ? 'text-3xl font-bold text-green-400' : 'text-3xl font-bold text-red-400';

        // Update P&L percentage
        const pnlPercentElement = document.getElementById('pnl-percent');
        const pnlPercent = stats.pnl_percent || 0;
        pnlPercentElement.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
        pnlPercentElement.className = pnlPercent >= 0 ? 'text-sm mt-1 text-green-400' : 'text-sm mt-1 text-red-400';

        // Update statistics
        document.getElementById('stat-total-trades').textContent = stats.total_trades || 0;
        document.getElementById('stat-winning').textContent = stats.winning_trades || 0;
        document.getElementById('stat-losing').textContent = stats.losing_trades || 0;
        document.getElementById('stat-win-rate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
        document.getElementById('stat-avg-win').textContent = `$${(stats.avg_win || 0).toFixed(2)}`;
        document.getElementById('stat-avg-loss').textContent = `$${(stats.avg_loss || 0).toFixed(2)}`;

        // Calculate and display R:R ratio
        const rrRatio = stats.avg_loss !== 0 ? Math.abs(stats.avg_win / stats.avg_loss) : 0;
        document.getElementById('stat-rr-ratio').textContent = `${rrRatio.toFixed(2)}:1`;

        document.getElementById('stat-largest-win').textContent = `$${(stats.largest_win || 0).toFixed(2)}`;
        document.getElementById('stat-largest-loss').textContent = `$${(stats.largest_loss || 0).toFixed(2)}`;

        // Update wallet summary
        document.getElementById('initial-balance').textContent = `$${(stats.initial_balance || 1000).toFixed(2)}`;
        document.getElementById('current-balance').textContent = `$${(stats.current_balance || 0).toFixed(2)}`;

    } catch (error) {
        console.error('Error fetching P&L stats:', error);
    }
}

async function fetchRecentTrades() {
    try {
        const response = await fetch('/api/simulated/trades?limit=20');

        if (response.status === 400) {
            return;
        }

        const trades = await response.json();
        const tbody = document.getElementById('recent-trades-table');

        if (!trades || trades.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                        No trades yet. Start trading to see results here!
                    </td>
                </tr>
            `;
            return;
        }

        const closedTrades = trades.filter(t => t.type === 'close');

        tbody.innerHTML = closedTrades.map(trade => {
            const pnlClass = trade.pnl >= 0 ? 'text-green-400' : 'text-red-400';
            const pnlSymbol = trade.pnl >= 0 ? '+' : '';
            const sideClass = trade.side === 'long' ? 'text-green-400' : 'text-red-400';
            const time = new Date(trade.timestamp).toLocaleString();

            return `
                <tr class="hover:bg-gray-700">
                    <td class="px-4 py-3 text-sm text-white">${trade.pair}</td>
                    <td class="px-4 py-3 text-sm ${sideClass} font-semibold">${trade.side.toUpperCase()}</td>
                    <td class="px-4 py-3 text-sm text-white">$${trade.entry_price.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-white">$${trade.close_price.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm ${pnlClass} font-bold">
                        ${pnlSymbol}$${trade.pnl.toFixed(2)} (${pnlSymbol}${trade.pnl_percent.toFixed(2)}%)
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-300">${trade.reason}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${time}</td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Error fetching recent trades:', error);
    }
}

async function fetchWalletInfo() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        document.getElementById('current-balance').textContent = `$${data.wallet.total_balance.toFixed(2)}`;
        document.getElementById('available-balance').textContent = `$${data.wallet.available_balance.toFixed(2)}`;
        document.getElementById('used-margin').textContent = `$${(data.wallet.locked_balance || 0).toFixed(2)}`;
    } catch (error) {
        console.error('Error fetching wallet info:', error);
    }
}

async function resetWallet() {
    if (!confirm('⚠️ WARNING: This will reset your simulated wallet!\n\nAll positions will be closed and your balance will be reset to $1000.\nAll trade history and statistics will be permanently deleted.\n\nAre you absolutely sure?')) {
        return;
    }

    if (!confirm('This is your final confirmation.\n\nReset wallet and delete all data?')) {
        return;
    }

    try {
        const response = await fetch('/api/simulated/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('✅ ' + result.message + '\n\nPage will refresh now.');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error resetting wallet:', error);
        alert('Failed to reset wallet. Please try again.');
    }
}

// Initial load
fetchPnLStats();
fetchRecentTrades();
fetchWalletInfo();
setInterval(fetchPnLStats, 5000);
setInterval(fetchRecentTrades, 5000);
setInterval(fetchWalletInfo, 5000);
</script>
{% endblock %}
